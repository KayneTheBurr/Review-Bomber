<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Review Bomber Client</title>
<style>
body { font-family: sans-serif; padding: 20px; }
.screen { display: none; margin-bottom: 15px; }
button { margin: 5px; }
textarea { width: 100%; height: 140px; }
.small { font-size: 0.9em; opacity: 0.85; }
.box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }

/* Connection status indicator */
.statusBar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0 18px;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    flex-wrap: wrap;
}
.dot { width: 10px; height: 10px; border-radius: 999px; background: #999; display: inline-block; }
.dot.ok { background: #2aa745; }
.dot.bad { background: #d64545; }
.dot.warn { background: #d0a400; }
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
.grow { flex: 1; }
.smallBtn { padding: 6px 10px; font-size: 0.9em; }

input.serverInput {
    width: 140px;
    padding: 4px;
}
</style>
</head>
<body>

<h1>Review Bomber (Client)</h1>

<!-- Connection Status -->
<div class="statusBar">
    <span id="connDot" class="dot warn"></span>

    <div>
        <label class="small">Server IP</label><br>
        <input id="serverIpInput" class="serverInput" placeholder="127.0.0.1">
    </div>

    <div>
        <label class="small">Port</label><br>
        <input id="serverPortInput" class="serverInput" placeholder="8080">
    </div>

    <div class="grow">
        <div><b>Status:</b> <span id="connLabel">Not connected</span></div>
        <div class="small mono" id="connDetail"></div>
    </div>

    <button id="reconnectBtn" class="smallBtn">Connect</button>
</div>

<!-- LOBBY -->
<div id="screenLobby" class="screen">
    <div id="sceneStateLobby" style="margin-bottom:15px;"></div>
    <label>Your Name:</label>
    <input type="text" id="nameInput">
    <button id="joinBtn">Join</button>
    <button id="startBtn" style="display:none;">Start Game</button>
</div>

<!-- PROMPT -->
<div id="screenPrompt" class="screen">
    <div id="sceneStatePrompt" style="margin-bottom:15px;"></div>

    <div class="box">
        <div class="small">Tagline Template:</div>
        <div id="taglineTemplateText"></div>
    </div>

    <label>Blank A:</label>
    <input type="text" id="blankAInput"><br><br>

    <label>Blank B:</label>
    <input type="text" id="blankBInput"><br><br>

    <button id="sendPromptBtn">Submit Tagline</button>
</div>

<!-- REVIEW -->
<div id="screenReview" class="screen">
    <div id="sceneStateReview" style="margin-bottom:15px;"></div>

    <div class="box">
        <div class="small">You are reviewing this tagline:</div>
        <div id="assignedTaglineText"></div>
    </div>

    <div class="box">
        <div class="small">Your required review tone:</div>
        <div id="assignedToneText"></div>
    </div>

    <label>Your Review:</label>
    <textarea id="reviewInput"></textarea><br>
    <button id="sendReviewBtn">Submit Review</button>
</div>

<!-- VOTE -->
<div id="screenVote" class="screen">
    <div id="sceneStateVote" style="margin-bottom:15px;"></div>

    <div class="box">
        <div class="small">Now rating entry <span id="voteIndex"></span> / <span id="voteCount"></span></div>
        <div class="small">Tagline:</div>
        <div id="currentTaglineText"></div>
        <hr>
        <div class="small">Review (<span id="currentReviewToneText"></span>):</div>
        <div id="currentReviewText"></div>
    </div>

    <div id="voteButtons"></div>
</div>

<!-- RESULTS -->
<div id="screenResults" class="screen">
    <div id="sceneStateResults" style="margin-bottom:15px;"></div>
    <div class="box">
        <div class="small">Top Results:</div>
        <pre id="resultsText" style="white-space:pre-wrap;"></pre>
    </div>
</div>

<script>
let ws;
let lastServerMessageAt = null;

/* Load saved server info */
const ipInput = document.getElementById("serverIpInput");
const portInput = document.getElementById("serverPortInput");

ipInput.value = localStorage.getItem("rb_server_ip") || "127.0.0.1";
portInput.value = localStorage.getItem("rb_server_port") || "8080";

function getWSUrl() {
    const ip = ipInput.value.trim();
    const port = portInput.value.trim();
    return `ws://${ip}:${port}`;
}

function setConnStatus(state, label, detail) {
    const dot = document.getElementById("connDot");
    dot.className = `dot ${state}`;
    document.getElementById("connLabel").textContent = label;
    document.getElementById("connDetail").textContent = detail;
}

function connect() {
    try { ws?.close(); } catch {}

    const url = getWSUrl();
    localStorage.setItem("rb_server_ip", ipInput.value);
    localStorage.setItem("rb_server_port", portInput.value);

    setConnStatus("warn", "Connecting…", url);

    ws = new WebSocket(url);

    ws.onopen = () => {
        setConnStatus("ok", "Connected", url);
        showScreen("screenLobby", "Connected. Waiting for server state…");
    };

    ws.onerror = () => {
        setConnStatus("bad", "Connection error", url);
    };

    ws.onclose = () => {
        setConnStatus("bad", "Disconnected", url);
    };

    ws.onmessage = (event) => {
        lastServerMessageAt = new Date();
        const state = JSON.parse(event.data);
        const msg = state.prompt || "";

        document.getElementById("startBtn").style.display =
            state.isFirst && (state.scene === "Lobby" || state.scene === "Wait")
                ? "inline" : "none";

        switch (state.scene) {
            case "Lobby": showScreen("screenLobby", msg); break;
            case "Prompt":
                showScreen("screenPrompt", msg);
                document.getElementById("taglineTemplateText").innerText = state.taglineTemplate || "";
                break;
            case "Review":
                showScreen("screenReview", msg);
                document.getElementById("assignedTaglineText").innerText = state.assignedTagline || "";
                document.getElementById("assignedToneText").innerText = state.assignedTone || "";
                break;
            case "Vote":
                showScreen("screenVote", msg);
                document.getElementById("voteIndex").innerText = state.entryIndex + 1;
                document.getElementById("voteCount").innerText = state.entryCount;
                document.getElementById("currentTaglineText").innerText = state.currentTagline;
                document.getElementById("currentReviewText").innerText = state.currentReview;
                document.getElementById("currentReviewToneText").innerText = state.currentReviewTone;
                buildStarButtons(state.starButtons || [1,2,3,4,5]);
                break;
            case "Results":
                showScreen("screenResults", msg);
                document.getElementById("resultsText").innerText = state.resultsText || "";
                break;
        }
    };
}

function send(obj) {
    if (ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(obj));
    }
}

function showScreen(id, msg) {
    document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
    const el = document.getElementById(id);
    el.style.display = "block";
    const scene = el.querySelector("div[id^='sceneState']");
    if (scene) scene.innerText = msg;
}

function buildStarButtons(arr) {
    const c = document.getElementById("voteButtons");
    c.innerHTML = "";
    arr.forEach((n, i) => {
        const b = document.createElement("button");
        b.innerText = n;
        b.onclick = () => {
            send({ type: "choice", index: i });
            c.querySelectorAll("button").forEach(x => x.disabled = true);
        };
        c.appendChild(b);
    });
}

document.getElementById("joinBtn").onclick = () =>
    send({ type: "join", name: nameInput.value });

document.getElementById("startBtn").onclick = () =>
    send({ type: "start" });

document.getElementById("sendPromptBtn").onclick = () =>
    send({ type: "input", a: blankAInput.value, b: blankBInput.value });

document.getElementById("sendReviewBtn").onclick = () =>
    send({ type: "input", text: reviewInput.value });

document.getElementById("reconnectBtn").onclick = connect;

window.onload = connect;
</script>

</body>
</html>
